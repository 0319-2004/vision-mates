# 招待・紹介機能 動作確認手順

## 1. データベース設定

### Supabase SQL Editorで実行
```sql
-- supabase/referral_schema.sql の内容をそのまま実行
```

## 2. 環境変数設定

`.env.local` ファイルに以下を追加：
```env
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

## 3. 動作確認手順

### 3.1 基本的な共有機能の確認

1. **プロジェクト詳細ページにアクセス**
   - `http://localhost:3000/projects/[プロジェクトID]` にアクセス
   - ページ下部に「このプロジェクトを共有」セクションが表示されることを確認

2. **共有ボタンの動作確認**
   - **リンクをコピー**: クリップボードに紹介URLがコピーされることを確認
   - **LINEで共有**: LINE共有ページが新しいタブで開くことを確認
   - **LinkedInで共有**: LinkedIn共有ページが新しいタブで開くことを確認
   - **Instagramで共有**: 
     - Web Share API対応環境: OSの共有シートが開くことを確認
     - 未対応環境: リンクがコピーされ、Instagram使い方モーダルが表示されることを確認

### 3.2 紹介URLの生成確認

1. **ログイン状態で共有**
   - ログイン後に共有ボタンをクリック
   - 生成されるURLに `?ref=<ユーザーID>&src=<ソース>&pid=<プロジェクトID>` が含まれることを確認

2. **未ログイン状態で共有**
   - ログアウト後に共有ボタンをクリック
   - 生成されるURLに `?src=<ソース>&pid=<プロジェクトID>` が含まれることを確認（refは含まれない）

### 3.3 紹介確定の確認

1. **紹介リンクでのアクセス**
   - 共有されたURLにアクセス
   - ブラウザの開発者ツールでCookieを確認
   - `vm_ref` Cookieが設定されていることを確認

2. **新規ユーザーでの紹介確定**
   - 別のブラウザまたはシークレットモードで紹介リンクにアクセス
   - 新規登録（Googleログイン）
   - ログイン成功時に「紹介が確定されました！」のトーストが表示されることを確認

3. **データベースでの確認**
   ```sql
   -- 紹介記録の確認
   SELECT * FROM invitations ORDER BY created_at DESC LIMIT 5;
   
   -- バッジの確認
   SELECT * FROM referral_badges;
   ```

### 3.4 バッジ付与の確認

1. **3人紹介でブロンズバッジ**
   - 3人分の紹介を実行
   - 設定ページでブロンズバッジが表示されることを確認

2. **10人紹介でシルバーバッジ**
   - 10人分の紹介を実行
   - 設定ページでシルバーバッジが表示されることを確認

3. **30人紹介でゴールドバッジ**
   - 30人分の紹介を実行
   - 設定ページでゴールドバッジが表示されることを確認

### 3.5 重複・不正防止の確認

1. **同一ユーザーの重複紹介**
   - 同じユーザーで複数回紹介リンクにアクセス
   - データベースで1回のみ記録されることを確認

2. **自己紹介の無効化**
   - 自分の紹介リンクにアクセス
   - データベースに記録されないことを確認

3. **有効期限の確認**
   - 48時間経過後の紹介リンクアクセス
   - 紹介が確定されないことを確認

### 3.6 設定ページの確認

1. **紹介統計の表示**
   - `/settings` ページにアクセス
   - 紹介数とバッジレベルが正しく表示されることを確認

2. **バッジ表示の確認**
   - 各バッジレベル（ブロンズ・シルバー・ゴールド）の表示を確認
   - 未獲得時の次のバッジまでの必要人数表示を確認

## 4. トラブルシューティング

### 4.1 よくある問題

1. **共有ボタンが表示されない**
   - `ShareButtons` コンポーネントが正しくインポートされているか確認
   - プロジェクト詳細ページの構造を確認

2. **紹介が確定されない**
   - Cookieが正しく設定されているか確認
   - サーバーアクションが正常に動作しているか確認
   - データベースのRLS設定を確認

3. **バッジが付与されない**
   - `award_referral_badges` 関数が正常に動作しているか確認
   - 紹介数が正しくカウントされているか確認

### 4.2 ログの確認

```bash
# 開発サーバーのログを確認
npm run dev

# ブラウザの開発者ツールでコンソールログを確認
```

### 4.3 データベースの確認

```sql
-- 紹介記録の詳細確認
SELECT 
  i.*,
  u1.email as referrer_email,
  u2.email as invited_email
FROM invitations i
LEFT JOIN auth.users u1 ON i.referrer_user_id = u1.id
LEFT JOIN auth.users u2 ON i.invited_user_id = u2.id
ORDER BY i.created_at DESC;

-- バッジ付与状況の確認
SELECT 
  rb.*,
  u.email
FROM referral_badges rb
LEFT JOIN auth.users u ON rb.user_id = u.id;
```

## 5. 本番環境での注意点

1. **環境変数の設定**
   - `NEXT_PUBLIC_SITE_URL` を本番URLに設定
   - Supabaseの本番環境でSQLを実行

2. **セキュリティ**
   - RLS設定が正しく動作しているか確認
   - 不正な紹介の防止機能が動作しているか確認

3. **パフォーマンス**
   - 大量の紹介データがある場合のクエリ最適化
   - バッジ付与処理の負荷確認 